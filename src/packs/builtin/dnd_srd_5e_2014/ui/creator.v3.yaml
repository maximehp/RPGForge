creator:
  schemaVersion: "3.0.0"
  title: D&D SRD 2014 Character Creator
  description: Roll20-style guided flow with strict validation and in-flow custom options.
  rules:
    - id: level-range
      severity: error
      when: "size(class_plan) > 0 and (level_total < 1 or level_total > 20)"
      message: "Total character level must be between 1 and 20."
  steps:
    - id: identity
      title: Identity
      description: Name your character and define campaign setup toggles.
      fields:
        - id: name
          label: Character Name
          type: text
          bindTo: name
          required: true
          default: New Adventurer
        - id: allow_multiclass
          label: Multiclass Enabled (Campaign Rule)
          type: toggle
          bindTo: allow_multiclass
          default: true

    - id: ancestry
      title: Race and Subrace
      preloadContentTypes: [races]
      searchContentTypes: [races]
      fields:
        - id: race_id
          label: Race
          type: select
          bindTo: race_id
          required: true
          options:
            kind: content
            contentType: races
        - id: subrace_id
          label: Subrace
          type: select
          bindTo: subrace_id
          options:
            kind: expression
            expression: "selectedRaceSubraces"

    - id: class_plan
      title: Class Plan and Subclasses
      preloadContentTypes: [classes]
      searchContentTypes: [classes]
      fields:
        - id: class_plan
          label: Class Distribution
          type: repeatGroup
          bindTo: class_plan
          required: true
          fields:
            - id: class_id
              label: Class
              type: select
              required: true
              options:
                kind: content
                contentType: classes
                filterExpression: "not has(optionMeta.data.subclass_of)"
            - id: levels
              label: Levels in Class
              type: number
              required: true
              default: 1
        - id: subclass_plan
          label: Subclass Selections
          type: repeatGroup
          bindTo: subclass_plan
          fields:
            - id: class_id
              label: Class
              type: select
              required: true
              options:
                kind: content
                contentType: classes
                filterExpression: "not has(optionMeta.data.subclass_of) and includes(selectedClassIds, option.value)"
            - id: subclass_id
              label: Subclass
              type: select
              required: true
              options:
                kind: content
                contentType: classes
                filterExpression: "has(optionMeta.data.subclass_of)"
        - id: warlock_pact_boon
          label: Warlock Pact Boon
          type: select
          bindTo: warlock_pact_boon
          visibleWhen: { expression: "classLevels.srd_warlock >= 3" }
          options:
            kind: static
            values:
              - { value: pact_of_the_blade, label: Pact of the Blade }
              - { value: pact_of_the_chain, label: Pact of the Chain }
              - { value: pact_of_the_tome, label: Pact of the Tome }
        - id: fighter_fighting_style
          label: Fighter Fighting Style
          type: select
          bindTo: fighter_fighting_style
          visibleWhen: { expression: "classLevels.srd_fighter >= 1" }
          options:
            kind: static
            values:
              - { value: archery, label: Archery }
              - { value: defense, label: Defense }
              - { value: dueling, label: Dueling }
              - { value: great_weapon_fighting, label: Great Weapon Fighting }
              - { value: protection, label: Protection }
              - { value: two_weapon_fighting, label: Two-Weapon Fighting }
        - id: cleric_divine_domain_focus
          label: Cleric Domain Focus
          type: select
          bindTo: cleric_divine_domain_focus
          visibleWhen: { expression: "classLevels.srd_cleric >= 1" }
          options:
            kind: static
            values:
              - { value: life, label: Life }
              - { value: knowledge, label: Knowledge }
              - { value: light, label: Light }
              - { value: nature, label: Nature }
              - { value: tempest, label: Tempest }
              - { value: trickery, label: Trickery }
              - { value: war, label: War }
        - id: rogue_expertise_choices
          label: Rogue Expertise Choices
          type: text
          bindTo: rogue_expertise_choices
          visibleWhen: { expression: "classLevels.srd_rogue >= 1" }
        - id: class_feature_choices
          label: Additional Class-Specific Choices
          type: repeatGroup
          bindTo: class_feature_choices
          fields:
            - id: class_id
              label: Class
              type: select
              options:
                kind: content
                contentType: classes
                filterExpression: "not has(optionMeta.data.subclass_of) and includes(selectedClassIds, option.value)"
            - id: choice_label
              label: Choice Category
              type: text
            - id: choice_value
              label: Chosen Option
              type: text

    - id: background
      title: Background and Proficiencies
      preloadContentTypes: [backgrounds]
      searchContentTypes: [backgrounds]
      fields:
        - id: background_id
          label: Background
          type: select
          bindTo: background_id
          required: true
          options:
            kind: content
            contentType: backgrounds
        - id: skill_choices
          label: Skill Proficiencies
          type: multiSelect
          bindTo: skill_choices
          options:
            kind: static
            values:
              - { value: acrobatics, label: Acrobatics }
              - { value: animal_handling, label: Animal Handling }
              - { value: arcana, label: Arcana }
              - { value: athletics, label: Athletics }
              - { value: deception, label: Deception }
              - { value: history, label: History }
              - { value: insight, label: Insight }
              - { value: intimidation, label: Intimidation }
              - { value: investigation, label: Investigation }
              - { value: medicine, label: Medicine }
              - { value: nature, label: Nature }
              - { value: perception, label: Perception }
              - { value: performance, label: Performance }
              - { value: persuasion, label: Persuasion }
              - { value: religion, label: Religion }
              - { value: sleight_of_hand, label: Sleight of Hand }
              - { value: stealth, label: Stealth }
              - { value: survival, label: Survival }
        - id: tool_choices
          label: Tool Proficiencies
          type: text
          bindTo: tool_choices
        - id: language_choices
          label: Languages
          type: text
          bindTo: language_choices

    - id: ability_scores
      title: Ability Scores
      description: Supports roll, point buy, standard array, and manual entry.
      fields:
        - id: ability_method
          label: Ability Score Method
          type: select
          bindTo: ability_method
          required: true
          default: roll
          options:
            kind: static
            values:
              - { value: roll, label: Roll (4d6 drop lowest) }
              - { value: point_buy, label: Point Buy (27 points) }
              - { value: standard_array, label: Standard Array }
              - { value: manual, label: Manual Entry }
        - id: score_rolls
          label: Rolled Scores
          type: roller
          bindTo: score_rolls
          visibleWhen: { expression: "ability_method == 'roll'" }
          roller:
            expression: "4d6"
            count: 6
            dropLowest: 1
            reroll:
              equals: 1
              maxRerolls: 6
            assignment: manual
        - id: str
          label: Strength
          type: number
          bindTo: stats.str
          required: true
          default: 10
        - id: dex
          label: Dexterity
          type: number
          bindTo: stats.dex
          required: true
          default: 10
        - id: con
          label: Constitution
          type: number
          bindTo: stats.con
          required: true
          default: 10
        - id: int
          label: Intelligence
          type: number
          bindTo: stats.int
          required: true
          default: 10
        - id: wis
          label: Wisdom
          type: number
          bindTo: stats.wis
          required: true
          default: 10
        - id: cha
          label: Charisma
          type: number
          bindTo: stats.cha
          required: true
          default: 10

    - id: feats_asi
      title: Feats and ASI
      preloadContentTypes: [feats]
      searchContentTypes: [feats]
      fields:
        - id: asi_choices
          label: ASI / Feat Choices
          type: repeatGroup
          bindTo: asi_choices
          fields:
            - id: choice_type
              label: Choice Type
              type: select
              required: true
              default: feat
              options:
                kind: static
                values:
                  - { value: feat, label: Feat }
                  - { value: asi, label: Ability Score Improvement }
            - id: feat_id
              label: Feat
              type: select
              visibleWhen: { expression: "row.choice_type == 'feat'" }
              options:
                kind: content
                contentType: feats
            - id: asi_stat
              label: ASI Details
              type: text
              visibleWhen: { expression: "row.choice_type == 'asi'" }

    - id: spells
      title: Spellcasting
      description: Select cantrips, known/prepared spells, and spellbook entries.
      preloadContentTypes: [spells, classes]
      searchContentTypes: [spells]
      fields:
        - id: cantrip_ids
          label: Cantrips
          type: multiSelect
          bindTo: cantrip_ids
          options:
            kind: content
            contentType: spells
            filterExpression: "optionMeta.data.level == 0 and intersects(optionClassKeys, selectedClassIds)"
        - id: spell_ids
          label: Spells Known / Prepared
          type: multiSelect
          bindTo: spell_ids
          options:
            kind: content
            contentType: spells
            filterExpression: "optionMeta.data.level > 0 and optionMeta.data.level <= spellLevelCap and intersects(optionClassKeys, selectedClassIds)"
        - id: spellbook_ids
          label: Spellbook Entries
          type: multiSelect
          bindTo: spellbook_ids
          options:
            kind: content
            contentType: spells
            filterExpression: "optionMeta.data.level > 0 and optionMeta.data.level <= spellLevelCap and intersects(optionClassKeys, selectedClassIds)"

    - id: equipment
      title: Equipment
      preloadContentTypes: [items]
      searchContentTypes: [items]
      fields:
        - id: equipment_package_ids
          label: Recommended Equipment Packages
          type: multiSelect
          bindTo: equipment_package_ids
          options:
            kind: expression
            expression: "recommendedEquipmentOptions"
        - id: starting_items
          label: Additional Starting Items
          type: multiSelect
          bindTo: starting_items
          options:
            kind: content
            contentType: items

    - id: review
      title: Review and Confirm
      description: Review your selections and confirm creation.
      fields:
        - id: review_ack
          label: I have reviewed this build
          type: toggle
          bindTo: review_ack
          required: true
